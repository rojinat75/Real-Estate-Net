{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Manually Create Premium Listing - Gorkha Real Estate Admin{% endblock %}

{% block extrastyle %}
<style>
.manual-premium-create {
    max-width: 900px;
    margin: 0 auto;
    padding: 30px;
}

.create-header {
    text-align: center;
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(135deg, #0033A0, #DC143C);
    color: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.create-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.2em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.create-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1em;
}

.form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.form-section {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 5px solid #0033A0;
}

.form-section h2 {
    color: #0033A0;
    margin-bottom: 20px;
    font-size: 1.4em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #495057;
    font-size: 1em;
}

.form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ced4da;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #0033A0;
    box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
}

.select-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ced4da;
    border-radius: 8px;
    font-size: 16px;
    background: white;
    transition: border-color 0.3s ease;
}

.select-control:focus {
    outline: none;
    border-color: #0033A0;
    box-shadow: 0 0 0 3px rgba(0, 51, 160, 0.1);
}

.property-preview {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
    margin-top: 15px;
    display: none;
}

.property-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: #f0f7ff;
    border-radius: 8px;
}

.detail-icon {
    color: #0033A0;
    font-size: 1.2em;
    width: 20px;
    text-align: center;
}

.detail-text {
    font-weight: 500;
    color: #495057;
}

.plan-preview {
    background: #DC143C;
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 15px;
    display: none;
}

.plan-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 10px;
}

.plan-price {
    font-size: 1.5em;
    font-weight: 900;
}

.plan-duration {
    opacity: 0.9;
}

.form-actions {
    text-align: center;
    margin-top: 40px;
    padding-top: 30px;
    border-top: 2px solid #e9ecef;
}

.submit-btn {
    background: linear-gradient(135deg, #0033A0, #DC143C);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 25px;
    font-size: 1.2em;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 51, 160, 0.3);
}

.cancel-btn {
    background: #6c757d;
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    margin-right: 15px;
}

.cancel-btn:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

/* Plan info styling */
.plan-info-card {
    background: linear-gradient(135deg, # DC143C, #0033A0);
    color: white;
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    text-align: center;
    display: none;
}

.plan-info-card h3 {
    margin: 0 0 10px 0;
    font-size: 1.6em;
}

.plan-info-card .price {
    font-size: 2.5em;
    font-weight: 900;
    margin-bottom: 10px;
}

.plan-info-card .duration {
    opacity: 0.9;
    font-size: 1.1em;
}

.alert {
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 500;
}

.alert-warning {
    background: #fff3cd;
    border: 1px solid #ffeeba;
    color: #856404;
}

.alert-success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

@media (max-width: 768px) {
    .manual-premium-create {
        padding: 20px;
    }

    .form-container {
        padding: 20px;
    }

    .property-info {
        grid-template-columns: 1fr;
    }

    .form-actions {
        text-align: center;
    }

    .form-actions .cancel-btn {
        display: block;
        margin: 0 auto 15px auto;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="manual-premium-create">
    <div class="create-header">
        <h1>üèÜ Manually Create Premium Listing</h1>
        <p>Add premium status to any property for any user</p>
    </div>

    <form method="post" class="form-container">
        {% csrf_token %}

        <!-- Step 1: Select Property -->
        <div class="form-section">
            <h2>üè† 1. Select Property</h2>
            <div class="form-group">
                <label for="property_id">Choose Property:</label>
                <select name="property_id" id="property_id" class="select-control" required onchange="updatePropertyPreview()">
                    <option value="">-- Select a property --</option>
                    {% for property in properties %}
                    <option value="{{ property.id }}">
                        {{ property.title }} - {{ property.city }}, {{ property.state }} ({{ property.user.username }})
                    </option>
                    {% endfor %}
                </select>
                <small style="color: #6c757d;">Shows recent properties and their owners</small>
            </div>

            <div id="property_preview" class="property-preview">
                <h3 style="margin-bottom: 15px; color: #0033A0;">Property Details</h3>
                <div class="property-info">
                    <div class="detail-item">
                        <i class="fas fa-user detail-icon"></i>
                        <span class="detail-text"><strong>Owner:</strong> <span id="property_owner">-</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt detail-icon"></i>
                        <span class="detail-text"><strong>Location:</strong> <span id="property_location">-</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-money-bill detail-icon"></i>
                        <span class="detail-text"><strong>Price:</strong> NPR <span id="property_price">-</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-home detail-icon"></i>
                        <span class="detail-text"><strong>Type:</strong> <span id="property_type">-</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Select User -->
        <div class="form-section">
            <h2>üë§ 2. Select User</h2>
            <div class="form-group">
                <label for="user_id">Choose User (Broker):</label>
                <select name="user_id" id="user_id" class="select-control" required onchange="updateUserInfo()">
                    <option value="">-- Select a broker --</option>
                    {% for user in users %}
                    <option value="{{ user.id }}">{{ user.username }} ({{ user.email }})</option>
                    {% endfor %}
                </select>
                <small style="color: #6c757d;">Only broker accounts can have premium listings</small>
            </div>

            <div id="user_info" class="property-preview" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #0033A0;">User Information</h3>
                <div class="property-info">
                    <div class="detail-item">
                        <i class="fas fa-envelope detail-icon"></i>
                        <span class="detail-text"><strong>Email:</strong> <span id="user_email">-</span></span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-user detail-icon"></i>
                        <span class="detail-text"><strong>Type:</strong> <span id="user_type">-</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Premium Plan Configuration -->
        <div class="form-section">
            <h2>üíé 3. Premium Plan Configuration</h2>

            <div class="form-group">
                <label for="plan_type">Plan Type:</label>
                <select name="plan_type" id="plan_type" class="select-control" required onchange="updatePlanInfo()">
                    <option value="">-- Select plan type --</option>
                    <option value="basic">Basic Premium (1 Week)</option>
                    <option value="featured">Featured Listing (1 Month)</option>
                    <option value="premium">Premium Plus (3 Months)</option>
                </select>
                <small style="color: #6c757d;">Different plans offer different durations and features</small>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div class="form-group">
                    <label for="amount_paid">Amount Paid (NPR):</label>
                    <input type="number" name="amount_paid" id="amount_paid" class="form-control" min="0" step="0.01" required>
                    <small style="color: #6c757d;">Payment amount for this premium listing</small>
                </div>

                <div class="form-group">
                    <label for="duration_days">Duration (Days):</label>
                    <input type="number" name="duration_days" id="duration_days" class="form-control" min="1" value="30" required>
                    <small style="color: #6c757d;">Premium duration in days</small>
                </div>
            </div>

            <div id="plan_info" class="plan-info-card">
                <h3 id="plan_name">-</h3>
                <div class="price">NPR <span id="plan_price">-</span></div>
                <div class="duration"><span id="plan_days">-</span> days duration</div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{% url 'admin:premium_premiumlisting_changelist' %}" class="cancel-btn">Cancel</a>
            <button type="submit" class="submit-btn">
                <i class="fas fa-star"></i> Create Premium Listing
            </button>
        </div>
    </form>
</div>

<script>
function updatePropertyPreview() {
    const propertySelect = document.getElementById('property_id');
    const propertyPreview = document.getElementById('property_preview');
    const selectedOption = propertySelect.options[propertySelect.selectedIndex];

    if (propertySelect.value) {
        propertyPreview.style.display = 'block';
        const textParts = selectedOption.text.split(' - ');
        const propertyName = textParts[0] || '';
        const locationInfo = textParts[1] || '';
        const userInfo = textParts[2] ? textParts[2].replace(/[()]/g, '') : '';

        document.getElementById('property_owner').textContent = userInfo;
        document.getElementById('property_location').textContent = locationInfo;
        document.getElementById('property_price').textContent = 'Price data available';
        document.getElementById('property_type').textContent = 'Property type available';
    } else {
        propertyPreview.style.display = 'none';
    }
}

function updateUserInfo() {
    const userSelect = document.getElementById('user_id');
    const userInfo = document.getElementById('user_info');
    const selectedOption = userSelect.options[userSelect.selectedIndex];

    if (userSelect.value) {
        userInfo.style.display = 'block';

        // Extract email from option text
        const emailMatch = selectedOption.text.match(/\(([^)]+)\)/);
        const userType = 'Broker'; // All users here are brokers

        document.getElementById('user_email').textContent = emailMatch ? emailMatch[1] : '';
        document.getElementById('user_type').textContent = userType;
    } else {
        userInfo.style.display = 'none';
    }
}

function updatePlanInfo() {
    const planSelect = document.getElementById('plan_type');
    const planInfo = document.getElementById('plan_info');
    const planName = document.getElementById('plan_name');
    const planPrice = document.getElementById('plan_price');
    const planDays = document.getElementById('plan_days');
    const amountInput = document.getElementById('amount_paid');
    const daysInput = document.getElementById('duration_days');

    const planData = {
        'basic': { name: 'Basic Premium', price: 500, days: 7 },
        'featured': { name: 'Featured Listing', price: 2000, days: 30 },
        'premium': { name: 'Premium Plus', price: 5000, days: 90 }
    };

    const selectedPlan = planSelect.value;
    if (selectedPlan && planData[selectedPlan]) {
        planInfo.style.display = 'block';
        planName.textContent = planData[selectedPlan].name;
        planPrice.textContent = planData[selectedPlan].price.toLocaleString();
        planDays.textContent = planData[selectedPlan].days;
        amountInput.value = planData[selectedPlan].price;
        daysInput.value = planData[selectedPlan].days;
    } else {
        planInfo.style.display = 'none';
    }
}

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const propertyId = document.getElementById('property_id').value;
    const userId = document.getElementById('user_id').value;
    const planType = document.getElementById('plan_type').value;

    if (!propertyId || !userId || !planType) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }

    // Show loading state
    this.querySelector('.submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
    this.querySelector('.submit-btn').disabled = true;
});
</script>
{% endblock %}
