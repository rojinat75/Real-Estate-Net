{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ property.title }} - {{ property.city }}, {{ property.state }}{% endblock %}

{% block content %}
<div class="property-detail-container">
    <div class="property-header">
        <h1>{{ property.title }}</h1>
        {% if property.is_premium %}
            <div class="premium-badge">Premium Listing</div>
        {% endif %}
        {% if property.is_verified %}
            <div class="verified-badge">Verified</div>
        {% endif %}
    </div>

    <div class="property-content">
        <div class="property-left">
            <!-- Image Gallery -->
            {% if property.images.all %}
            <div class="image-gallery">
                <div class="main-image">
                    <img id="current-image" src="{{ property.images.first.image.url }}" alt="{{ property.images.first.caption }}">
                </div>
                {% if property.images.count > 1 %}
                <div class="thumbnail-strip">
                    {% for image in property.images.all %}
                    <img src="{{ image.image.url }}" alt="{{ image.caption }}" class="thumbnail {% if forloop.first %}active{% endif %}" onclick="changeImage(this.src)">
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% elif property.floor_plan_image %}
            <div class="image-gallery">
                <div class="main-image">
                    <img src="{{ property.floor_plan_image.url }}" alt="Floor Plan">
                </div>
            </div>
            {% else %}
            <div class="no-image-gallery">
                <div class="no-image-placeholder">No images available</div>
            </div>
            {% endif %}

            <!-- Virtual Tour & Floor Plan -->
            <div class="media-section">
                {% if property.virtual_tour_url %}
                <div class="virtual-tour">
                    <h3>Virtual Tour</h3>
                    <div class="tour-link">
                        <a href="{{ property.virtual_tour_url }}" target="_blank" class="tour-btn">Take 3D Virtual Tour</a>
                    </div>
                </div>
                {% endif %}

                {% if property.floor_plan_image %}
                <div class="floor-plan">
                    <h3>Floor Plan</h3>
                    <img src="{{ property.floor_plan_image.url }}" alt="Floor Plan" class="floor-plan-img">
                </div>
                {% endif %}
            </div>

            <div class="property-info-section">
                <h3>Property Details</h3>
                <div class="property-details-grid">
                    <div class="detail-item"><strong>Price:</strong> NPR {{ property.price|intcomma }}</div>
                    <div class="detail-item"><strong>Location:</strong> {{ property.address }}, {{ property.city }}, {{ property.state }} {{ property.zip_code }}</div>
                    <div class="detail-item"><strong>Property Type:</strong> {{ property.property_type }}</div>
                    <div class="detail-item"><strong>Status:</strong> {{ property.get_status_display }}</div>
                    {% if property.square_footage %}
                    <div class="detail-item"><strong>Square Footage:</strong> {{ property.square_footage|intcomma }} sq ft</div>
                    {% endif %}
                    {% if property.lot_size %}
                    <div class="detail-item"><strong>Lot Size:</strong> {{ property.lot_size|floatformat:2 }} acres</div>
                    {% endif %}
                    {% if property.year_built %}
                    <div class="detail-item"><strong>Year Built:</strong> {{ property.year_built }}</div>
                    {% endif %}
                    {% if property.zoning %}
                    <div class="detail-item"><strong>Zoning:</strong> {{ property.zoning }}</div>
                    {% endif %}
                </div>

                {% if property.cap_rate or property.noi %}
                <h3>Financial Information</h3>
                <div class="financial-details">
                    {% if property.cap_rate %}
                    <div><strong>Cap Rate:</strong> {{ property.cap_rate }}%</div>
                    {% endif %}
                    {% if property.noi %}
                    <div><strong>Net Operating Income (NOI):</strong> NPR {{ property.noi|intcomma }}</div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <div class="description-section">
                <h3>Description</h3>
                <p>{{ property.description }}</p>
            </div>

            {% if property.amenities.all %}
            <div class="amenities-section">
                <h3>Amenities</h3>
                <div class="amenities-grid">
                    {% for amenity in property.amenities.all %}
                    <div class="amenity-item">{{ amenity.name }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if property.rent_roll %}
            <div class="rent-roll-section">
                <h3>Rent Roll</h3>
                <div class="rent-roll-content">{{ property.rent_roll|linebreaksbr }}</div>
            </div>
            {% endif %}

            {% if property.expense_summaries %}
            <div class="expense-section">
                <h3>Expense Summaries</h3>
                <div class="expense-content">{{ property.expense_summaries|linebreaksbr }}</div>
            </div>
            {% endif %}
        </div>

        <div class="property-right">
            <!-- Agent Information -->
            <div class="agent-widget">
                <h3>Contact Agent</h3>
                <div class="agent-info">
                    {% if property.user.profile_image %}
                        <img src="{{ property.user.profile_image.url }}" alt="Agent" class="agent-image">
                    {% endif %}
                    <div class="agent-details">
                        <h4>{{ property.broker_name|default:property.user.get_full_name|default:property.user.username }}</h4>
                        {% if property.broker_email %}
                            <p><i class="fas fa-envelope"></i> {{ property.broker_email }}</p>
                        {% elif property.user.email %}
                            <p><i class="fas fa-envelope"></i> {{ property.user.email }}</p>
                        {% endif %}
                        {% if property.broker_phone %}
                            <p><i class="fas fa-phone"></i> {{ property.broker_phone }}</p>
                        {% elif property.user.phone_number %}
                            <p><i class="fas fa-phone"></i> {{ property.user.phone_number }}</p>
                        {% endif %}
                        {% if property.user.company_name %}
                            <p><i class="fas fa-building"></i> {{ property.user.company_name }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Form -->
                <div class="contact-form">
                    <form method="post" action="{% url 'contact:contact_form' %}">
                        {% csrf_token %}
                        <input type="hidden" name="property_id" value="{{ property.pk }}">
                        <input type="text" name="name" placeholder="Your Name" required>
                        <input type="email" name="email" placeholder="Your Email" required>
                        <input type="text" name="subject" placeholder="Subject" required value="Inquiry about {{ property.title }}">
                        <textarea name="message" placeholder="Your message..." required rows="4"></textarea>
                        <button type="submit" class="contact-submit-btn">Send Message</button>
                    </form>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <a href="#" class="share-btn"> <i class="fas fa-share"></i> Share Listing</a>
                <a href="#" class="print-btn"><i class="fas fa-print"></i> Print Details</a>
                {% if user.is_authenticated %}
                    <a href="#" class="favorite-btn"><i class="fas fa-heart"></i> Add to Favorites</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.property-detail-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.property-header {
    text-align: center;
    margin-bottom: 40px;
}

.property-header h1 {
    font-size: 2.5em;
    color: var(--nepal-blue);
    margin: 0 0 10px 0;
}

.premium-badge {
    display: inline-block;
    background: gold;
    color: #333;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
}

.verified-badge {
    display: inline-block;
    background: green;
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9em;
    margin-left: 10px;
}

.property-content {
    display: flex;
    gap: 40px;
}

.property-left {
    flex: 1;
}

.property-right {
    width: 300px;
}

.image-gallery {
    margin-bottom: 30px;
}

.main-image img {
    width: 100%;
    height: 400px;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid #ddd;
}

.thumbnail-strip {
    display: flex;
    margin-top: 10px;
    gap: 10px;
}

.thumbnail {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid #ddd;
    transition: border-color 0.3s ease;
}

.thumbnail:hover,
.thumbnail.active {
    border-color: var(--nepal-blue);
}

.no-image-gallery {
    background: linear-gradient(135deg, var(--nepal-blue), var(--nepal-crimson));
    height: 400px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    color: white;
    font-size: 1.5em;
    font-weight: bold;
}

.media-section {
    display: flex;
    gap: 20px;
    margin-bottom: 30px;
}

.virtual-tour,
.floor-plan {
    flex: 1;
}

.tour-link {
    text-align: center;
}

.tour-btn {
    background: var(--nepal-blue);
    color: white;
    padding: 15px 30px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
    display: inline-block;
    transition: background-color 0.3s ease;
}

.tour-btn:hover {
    background: #002a70;
}

.floor-plan-img {
    width: 100%;
    border-radius: 5px;
    border: 2px solid #ddd;
}

.property-info-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.property-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.detail-item {
    margin: 10px 0;
}

.financial-details div {
    margin: 10px 0;
}

.description-section {
    margin-bottom: 30px;
}

.description-section p {
    line-height: 1.6;
    font-size: 1.1em;
}

.amenities-section {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.amenities-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.amenity-item {
    background: white;
    padding: 8px 15px;
    border-radius: 20px;
    border: 1px solid #ddd;
    font-size: 0.9em;
}

.agent-widget {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

.agent-info {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
}

.agent-image {
    width: 60px;
    height: 60px;
    border-radius: 50%;
}

.agent-details h4 {
    margin: 0 0 10px 0;
    color: var(--nepal-blue);
}

.agent-details p {
    margin: 5px 0;
    font-size: 0.9em;
}

.contact-form input,
.contact-form textarea {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-family: inherit;
}

.contact-submit-btn {
    width: 100%;
    background: var(--nepal-crimson);
    color: white;
    border: none;
    padding: 12px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.contact-submit-btn:hover {
    background: var(--nepal-border);
}

.quick-actions {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.quick-actions a {
    display: block;
    color: var(--nepal-blue);
    text-decoration: none;
    margin: 10px 0;
    transition: color 0.3s ease;
}

.quick-actions a:hover {
    color: #002a70;
}

@media (max-width: 768px) {
    .property-content {
        flex-direction: column;
    }

    .property-right {
        width: 100%;
    }

    .media-section {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/script.js' %}"></script>
<script>
function changeImage(newSrc) {
    document.getElementById('current-image').src = newSrc;
    // Update active thumbnail
    const thumbnails = document.querySelectorAll('.thumbnail');
    thumbnails.forEach(thumb => thumb.classList.remove('active'));
    event.target.classList.add('active');
}
</script>
{% endblock %}
